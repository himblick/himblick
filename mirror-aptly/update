#!/bin/sh
set -uex

# Packages we need
NEEDED="Priority (required)|ansible|dracut|cpufrequtils|libnss-systemd|libpam-cap|xserver-xorg|openbox|xterm|fonts-droid-fallback|fonts-liberation2|xfonts-base|lightdm|x11-xserver-utils|python3-pyinotify|python3-tornado|libjs-jquery|libjs-bootstrap4|fonts-fork-awesome|caffeine|vlc|okular|feh|libreoffice-impress|libreoffice-avmedia-backend-vlc|python3-cffi-backend|python-apt|exfat-fuse|exfat-utils|aptitude|kinit|kio|libkf5parts5|libkf5wallet-bin|libkf5wallet5|libokular5core8|phonon4qt5|phonon4qt5-backend-vlc|xserver-xorg-core|xserver-xorg-video-all|xserver-xorg-input-all|xorg-driver-input|xorg-driver-video|vlc-plugin-video-output|libgl1|libglx-mesa0|libllvm8"

IMAGE_PACKAGES="adduser|alsa-utils|apt|apt-listchanges|apt-utils|avahi-daemon|base-files|base-passwd|bash|bash-completion|bind9-host|binutils|binutils-arm-linux-gnueabihf|binutils-common|bluez|bluez-firmware|bsdmainutils|bsdutils|build-essential|bzip2|ca-certificates|cifs-utils|console-setup|console-setup-linux|coreutils|cpio|cpp|cpp-8|crda|cron|curl|dash|dbus|dc|debconf|debconf-i18n|debconf-utils|debianutils|device-tree-compiler|dhcpcd5|diffutils|dirmngr|distro-info-data|dmidecode|dmsetup|dosfstools|dphys-swapfile|dpkg|dpkg-dev|e2fsprogs|ed|ethtool|fake-hwclock|fakeroot|fbset|fdisk|file|findutils|firmware-atheros|firmware-brcm80211|firmware-libertas|firmware-misc-nonfree|firmware-realtek|flashrom|freetype2-doc|fuse|g++|g++-8|gcc|gcc-4.9-base|gcc-5-base|gcc-6-base|gcc-7-base|gcc-8|gcc-8-base|gdb|gdbm-l10n|geoip-database|gettext-base|gnupg|gnupg-l10n|gnupg-utils|gpg|gpg-agent|gpg-wks-client|gpg-wks-server|gpgconf|gpgsm|gpgv|grep|groff-base|gzip|hardlink|hostname|htop|ifupdown|info|init|init-system-helpers|install-info|iproute2|iptables|iputils-ping|isc-dhcp-client|isc-dhcp-common|iso-codes|iw|javascript-common|kbd|keyboard-configuration|keyutils|kmod|less|libacl1|libalgorithm-diff-perl|libalgorithm-diff-xs-perl|libalgorithm-merge-perl|libapparmor1|libapt-inst2.0|libapt-pkg5.0|libargon2-1|libasan5|libasound2|libasound2-data|libassuan0|libatomic1|libattr1|libaudit-common|libaudit1|libavahi-common-data|libavahi-common3|libavahi-core7|libbabeltrace1|libbind9-161|libbinutils|libblkid1|libboost-iostreams1.58.0|libbsd0|libbz2-1.0|libc-bin|libc-dev-bin|libc-l10n|libc6|libc6-dbg|libc6-dev|libcap-ng0|libcap2|libcap2-bin|libcc1-0|libcom-err2|libcryptsetup12|libcurl4|libdaemon0|libdb5.3|libdbus-1-3|libdebconfclient0|libdevmapper1.02.1|libdns-export1104|libdns1104|libdpkg-perl|libdw1|libedit2|libelf1|libestr0|libevent-2.1-6|libexpat1|libext2fs2|libfakeroot|libfastjson4|libfdisk1|libffi6|libfftw3-single3|libfile-fcntllock-perl|libfreetype6|libfreetype6-dev|libfribidi0|libfstrm0|libftdi1-2|libfuse2|libgcc-8-dev|libgcc1|libgcrypt20|libgdbm-compat4|libgdbm6|libgeoip1|libglib2.0-0|libglib2.0-data|libgmp10|libgnutls30|libgomp1|libgpg-error0|libgpm2|libgssapi-krb5-2|libhogweed4|libicu63|libident|libidn11|libidn2-0|libip4tc0|libip6tc0|libiptc0|libisc-export1100|libisc1100|libisccc161|libisccfg163|libisl19|libiw30|libjim0.77|libjpeg62-turbo|libjs-jquery|libjson-c3|libk5crypto3|libkeyutils1|libkmod2|libkrb5-3|libkrb5support0|libksba8|libldap-2.4-2|libldap-common|liblmdb0|liblocale-gettext-perl|liblognorm5|libluajit-5.1-2|libluajit-5.1-common|liblwres161|liblz4-1|liblzma5|libmagic-mgc|libmagic1|libmnl-dev|libmnl0|libmount1|libmpc3|libmpdec2|libmpfr6|libmtp-common|libmtp-runtime|libmtp9|libncurses6|libncursesw5|libncursesw6|libnetfilter-conntrack3|libnettle6|libnewt0.52|libnfnetlink0|libnfsidmap2|libnftnl11|libnghttp2-14|libnl-3-200|libnl-genl-3-200|libnl-route-3-200|libnpth0|libnss-mdns|libntfs-3g883|libp11-kit0|libpam-chksshpwd|libpam-modules|libpam-modules-bin|libpam-runtime|libpam-systemd|libpam0g|libparted2|libpci3|libpcre2-8-0|libpcre2-posix0|libpcre3|libpcsclite1|libperl5.28|libpipeline1|libpng-dev|libpng-tools|libpng16-16|libpolkit-agent-1-0|libpolkit-backend-1-0|libpolkit-gobject-1-0|libpopt0|libprocps7|libprotobuf-c1|libpsl5|libpython-stdlib|libpython2-stdlib|libpython2.7-minimal|libpython2.7-stdlib|libpython3-stdlib|libpython3.7|libpython3.7-minimal|libpython3.7-stdlib|libraspberrypi-bin|libraspberrypi-dev|libraspberrypi-doc|libraspberrypi0|libreadline6|libreadline7|librtmp1|libsamplerate0|libsasl2-2|libsasl2-modules-db|libseccomp2|libselinux1|libsemanage-common|libsemanage1|libsepol1|libsigc++-1.2-5c2|libslang2|libsmartcols1|libsqlite3-0|libss2|libssh2-1|libssl1.1|libstdc++-8-dev|libstdc++6|libsystemd0|libtalloc2|libtasn1-6|libtext-charwidth-perl|libtext-iconv-perl|libtext-wrapi18n-perl|libtinfo5|libtinfo6|libtirpc-common|libtirpc3|libubsan1|libuchardet0|libudev0|libudev1|libunistring2|libusb-0.1-4|libusb-1.0-0|libuuid1|libv4l-0|libv4l2rds0|libv4lconvert0|libwbclient0|libwrap0|libx11-6|libx11-data|libxau6|libxcb1|libxdmcp6|libxext6|libxml2|libxmuu1|libxtables12|libzstd1|linux-libc-dev|locales|login|logrotate|lsb-base|lsb-release|lua5.1|luajit|make|man-db|manpages|manpages-dev|mawk|mime-support|mount|multiarch-support|nano|ncdu|ncurses-base|ncurses-bin|ncurses-term|net-tools|netbase|netcat-openbsd|netcat-traditional|nfs-common|ntfs-3g|openresolv|openssh-client|openssh-server|openssh-sftp-server|openssl|parted|passwd|patch|paxctld|pciutils|perl|perl-base|perl-modules-5.28|pi-bluetooth|pinentry-curses|pkg-config|policykit-1|procps|psmisc|publicsuffix|python|python-apt-common|python-minimal|python-rpi.gpio|python2|python2-minimal|python2.7|python2.7-minimal|python3|python3-apt|python3-certifi|python3-chardet|python3-debconf|python3-idna|python3-minimal|python3-pkg-resources|python3-requests|python3-six|python3-urllib3|python3.7|python3.7-minimal|raspberrypi-bootloader|raspberrypi-kernel|raspberrypi-net-mods|raspberrypi-sys-mods|raspbian-archive-keyring|raspi-config|raspi-copies-and-fills|readline-common|rfkill|rng-tools|rpcbind|rpi-eeprom|rpi-eeprom-images|rpi-update|rsync|rsyslog|sed|sensible-utils|shared-mime-info|ssh|ssh-import-id|strace|sudo|systemd|systemd-sysv|sysvinit-utils|tar|tasksel|tasksel-data|traceroute|triggerhappy|tzdata|ucf|udev|unzip|usb-modeswitch|usb-modeswitch-data|usb.ids|usbutils|util-linux|v4l-utils|vim-common|vim-tiny|vl805fw|wget|whiptail|wireless-regdb|wireless-tools|wpasupplicant|xauth|xdg-user-dirs|xkb-data|xxd|xz-utils|zlib1g|zlib1g-dev|libgpgme11|libgpgmepp6|gir1.2-gtk-3.0|gtk-update-icon-cache|libcairo-gobject2|libdrm-amdgpu1|libdrm-etnaviv1|libdrm-nouveau2|libdrm-radeon1|libegl-mesa0|libegl1-mesa|libgbm1|libgl1-mesa-dri|libglapi-mesa|libglx-mesa0|libgtk-3-0|libgtk-3-common|libvlc-bin|libvlc5|libvlccore9|vlc|vlc-bin|vlc-data|vlc-plugin-base|vlc-plugin-qt|vlc-plugin-video-output|xdg-utils|xserver-common|xserver-xorg-core"

FILTER="$NEEDED|$IMAGE_PACKAGES"

aptly --config=.aptly.conf mirror edit --dep-verbose-resolve --filter="$FILTER" --filter-with-deps raspbian
aptly --config=.aptly.conf --keyring=`pwd`/trusted.gpg mirror update raspbian

aptly --config=.aptly.conf mirror edit --dep-verbose-resolve --filter="$FILTER" --filter-with-deps debian
aptly --config=.aptly.conf --keyring=`pwd`/trusted.gpg mirror update debian

# aptly --config=.aptly.conf repo add himblick fixed-vlc/*
# aptly --config=.aptly.conf repo add himblick ../../himblick_1.0-1_all.deb
